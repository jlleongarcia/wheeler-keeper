{% extends 'maintenance/base.html' %}

{% block title %}Registrar Mantenimiento - Wheeler Keeper{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <form method="post" id="maintenanceForm">
                {% csrf_token %}
                
                <!-- Información Básica del Mantenimiento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> Información Básica</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.vehiculo.id_for_label }}" class="form-label">Vehículo *</label>
                                    {{ form.vehiculo }}
                                    {% if form.vehiculo.errors %}
                                        <div class="text-danger">{{ form.vehiculo.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.fecha_realizacion.id_for_label }}" class="form-label">Fecha de Realización *</label>
                                    {{ form.fecha_realizacion }}
                                    {% if form.fecha_realizacion.errors %}
                                        <div class="text-danger">{{ form.fecha_realizacion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.kilometraje_realizacion.id_for_label }}" class="form-label">Kilometraje *</label>
                                    {{ form.kilometraje_realizacion }}
                                    {% if form.kilometraje_realizacion.errors %}
                                        <div class="text-danger">{{ form.kilometraje_realizacion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.taller.id_for_label }}" class="form-label">Taller/Lugar</label>
                                    {{ form.taller }}
                                    {% if form.taller.errors %}
                                        <div class="text-danger">{{ form.taller.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.costo_mano_obra_total.id_for_label }}" class="form-label">Costo Total de Mano de Obra</label>
                                    <div class="input-group">
                                        {{ form.costo_mano_obra_total }}
                                        <span class="input-group-text">€</span>
                                    </div>
                                    {% if form.costo_mano_obra_total.errors %}
                                        <div class="text-danger">{{ form.costo_mano_obra_total.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.iva_incluido }}
                                        <label class="form-check-label" for="{{ form.iva_incluido.id_for_label }}">
                                            <i class="bi bi-receipt"></i> IVA incluido (21%)
                                        </label>
                                        <small class="form-text text-muted d-block">
                                            Si no está marcado, se añadirá el 21% de IVA al total
                                        </small>
                                    </div>
                                    {% if form.iva_incluido.errors %}
                                        <div class="text-danger">{{ form.iva_incluido.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.notas_generales.id_for_label }}" class="form-label">Notas Generales</label>
                                    {{ form.notas_generales }}
                                    {% if form.notas_generales.errors %}
                                        <div class="text-danger">{{ form.notas_generales.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Ítems de Mantenimiento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check"></i> Trabajos y Piezas Realizadas</h5>
                        <small class="text-muted">Especifica cada trabajo o pieza individual (mínimo 1 ítem requerido)</small>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        
                        <div id="formset-container">
                            {% for form in formset %}
                                <div class="formset-form border rounded p-3 mb-3" style="{% if forloop.first %}{% else %}display: none;{% endif %}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Ítem <span class="item-number">{{ forloop.counter }}</span></h6>
                                        {% if not forloop.first %}
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-form">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Tipo de Trabajo *</label>
                                                {{ form.tipo_mantenimiento }}
                                                {% if form.tipo_mantenimiento.errors %}
                                                    <div class="text-danger">{{ form.tipo_mantenimiento.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Descripción</label>
                                                {{ form.descripcion }}
                                                {% if form.descripcion.errors %}
                                                    <div class="text-danger">{{ form.descripcion.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Cantidad</label>
                                                {{ form.cantidad }}
                                                {% if form.cantidad.errors %}
                                                    <div class="text-danger">{{ form.cantidad.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Costo Unitario (€) *</label>
                                                {{ form.costo_unitario }}
                                                {% if form.costo_unitario.errors %}
                                                    <div class="text-danger">{{ form.costo_unitario.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Costo Total</label>
                                                <input type="text" class="form-control costo-total-display" readonly placeholder="0.00 €">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if formset.can_delete %}
                                        {{ form.DELETE }}
                                    {% endif %}
                                    {{ form.id }}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary" id="add-form">
                            <i class="bi bi-plus-circle"></i> Añadir otro ítem
                        </button>
                        
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>Resumen de Costos:</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Materiales: <span id="total-materiales">0.00</span> €</strong>
                                </div>
                                <div class="col-md-3">
                                    <strong>Mano de Obra: <span id="total-mano-obra">0.00</span> €</strong>
                                </div>
                                <div class="col-md-3">
                                    <strong>IVA (21%): <span id="total-iva">Incluido</span> €</strong>
                                </div>
                                <div class="col-md-3">
                                    <strong>Total: <span id="total-general">0.00</span> €</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-3">
                    <button type="submit" class="btn btn-primary btn-lg me-2">
                        <i class="bi bi-check-circle"></i> Registrar Mantenimiento
                    </button>
                    <a href="{% url 'maintenance:lista_mantenimientos' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Espacio adicional en la parte inferior -->
    <div style="height: 100px;"></div>
</div>

<!-- JavaScript para manejo dinámico de formsets -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    
    // Función para calcular costos totales
    function calculateTotals() {
        let totalMateriales = 0;
        let manoObraTotal = 0;
        
        // Calcular total de materiales (suma de todos los ítems)
        document.querySelectorAll('.formset-form:not([style*="display: none"])').forEach(function(form) {
            const cantidad = parseFloat(form.querySelector('input[name$="cantidad"]').value) || 0;
            const costoUnitario = parseFloat(form.querySelector('input[name$="costo_unitario"]').value) || 0;
            const costoTotal = cantidad * costoUnitario;
            
            // Actualizar display del costo total del ítem
            const costoTotalDisplay = form.querySelector('.costo-total-display');
            if (costoTotalDisplay) {
                costoTotalDisplay.value = costoTotal.toFixed(2) + ' €';
            }
            
            totalMateriales += costoTotal;
        });
        
        // Obtener costo de mano de obra
        const manoObraInput = document.getElementById('id_costo_mano_obra_total');
        if (manoObraInput) {
            manoObraTotal = parseFloat(manoObraInput.value) || 0;
        }
        
        // Calcular subtotal (sin IVA)
        const subtotal = totalMateriales + manoObraTotal;
        
        // Verificar si IVA está incluido
        const ivaIncluidoCheckbox = document.getElementById('id_iva_incluido');
        const ivaIncluido = ivaIncluidoCheckbox ? ivaIncluidoCheckbox.checked : true;
        
        // Calcular IVA
        const ivaImporte = ivaIncluido ? 0 : subtotal * 0.21;
        const totalFinal = subtotal + ivaImporte;
        
        // Actualizar displays
        document.getElementById('total-materiales').textContent = totalMateriales.toFixed(2);
        document.getElementById('total-mano-obra').textContent = manoObraTotal.toFixed(2);
        
        // Actualizar el display del IVA y total
        const ivaDisplay = document.getElementById('total-iva');
        const totalDisplay = document.getElementById('total-general');
        
        if (ivaDisplay) {
            if (ivaIncluido) {
                ivaDisplay.textContent = 'Incluido';
                ivaDisplay.parentElement.style.opacity = '0.6';
            } else {
                ivaDisplay.textContent = ivaImporte.toFixed(2);
                ivaDisplay.parentElement.style.opacity = '1';
            }
        }
        
        if (totalDisplay) {
            totalDisplay.textContent = totalFinal.toFixed(2);
        }
    }
    
    // Función para actualizar índices de formularios
    function updateFormIndices() {
        const forms = formsetContainer.querySelectorAll('.formset-form:not([style*="display: none"])');
        forms.forEach(function(form, index) {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(function(input) {
                if (input.name) {
                    input.name = input.name.replace(/items-\d+-/, `items-${index}-`);
                }
                if (input.id) {
                    input.id = input.id.replace(/id_items-\d+-/, `id_items-${index}-`);
                }
            });
            
            const labels = form.querySelectorAll('label[for]');
            labels.forEach(function(label) {
                if (label.htmlFor) {
                    label.htmlFor = label.htmlFor.replace(/id_items-\d+-/, `id_items-${index}-`);
                }
            });
            
            // Actualizar número del ítem
            const itemNumber = form.querySelector('.item-number');
            if (itemNumber) {
                itemNumber.textContent = index + 1;
            }
        });
        
        totalFormsInput.value = forms.length;
        
        // Reasignar event listeners para los nuevos campos
        attachFormEventListeners();
        calculateTotals();
        
        // Actualizar estado del botón añadir
        if (typeof updateAddButton === 'function') {
            updateAddButton();
        }
    }
    
    // Función para asignar event listeners a los campos de formularios
    function attachFormEventListeners() {
        const quantityInputs = document.querySelectorAll('input[id*="cantidad"]');
        const priceInputs = document.querySelectorAll('input[id*="precio_unitario"]');
        
        quantityInputs.forEach(function(input) {
            input.removeEventListener('input', calculateTotals);
            input.addEventListener('input', calculateTotals);
        });
        
        priceInputs.forEach(function(input) {
            input.removeEventListener('input', calculateTotals);
            input.addEventListener('input', calculateTotals);
        });
    }
    
    // Función para crear un formulario nuevo dinámicamente
    function createNewFormDynamically() {
        const visibleForms = formsetContainer.querySelectorAll('.formset-form:not([style*="display: none"])');
        const maxForms = parseInt(document.getElementById('id_items-MAX_NUM_FORMS').value) || 20;
        
        if (visibleForms.length >= maxForms) {
            return; // No crear si ya estamos en el límite
        }
        
        // Clonar el primer formulario como template
        const firstForm = formsetContainer.querySelector('.formset-form');
        const newForm = firstForm.cloneNode(true);
        
        // Limpiar los valores del nuevo formulario
        const inputs = newForm.querySelectorAll('input:not([type="hidden"]), select, textarea');
        inputs.forEach(function(input) {
            if (input.type !== 'hidden') {
                input.value = '';
            }
        });
        
        // Mostrar el formulario
        newForm.style.display = 'block';
        
        // Añadir botón de eliminar
        const headerDiv = newForm.querySelector('.d-flex.justify-content-between');
        if (headerDiv && !headerDiv.querySelector('.remove-form')) {
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-outline-danger btn-sm remove-form';
            removeButton.innerHTML = '<i class="bi bi-trash"></i> Eliminar';
            removeButton.addEventListener('click', function() {
                newForm.remove();
                updateFormIndices();
            });
            headerDiv.appendChild(removeButton);
        }
        
        // Añadir el nuevo formulario al contenedor
        formsetContainer.appendChild(newForm);
    }
    
    // Función para añadir nuevo formulario
    addButton.addEventListener('click', function() {
        const hiddenForms = formsetContainer.querySelectorAll('.formset-form[style*="display: none"]');
        const visibleForms = formsetContainer.querySelectorAll('.formset-form:not([style*="display: none"])');
        const maxForms = parseInt(document.getElementById('id_items-MAX_NUM_FORMS').value) || 20;
        
        // Verificar si ya hemos alcanzado el límite máximo
        if (visibleForms.length >= maxForms) {
            alert(`Solo se pueden añadir máximo ${maxForms} ítems de mantenimiento.`);
            return;
        }
        
        if (hiddenForms.length > 0) {
            // Mostrar el primer formulario oculto
            const formToShow = hiddenForms[0];
            formToShow.style.display = 'block';
            
            // Añadir botón de eliminar si no lo tiene
            const removeButton = formToShow.querySelector('.remove-form');
            if (removeButton) {
                removeButton.addEventListener('click', function() {
                    formToShow.style.display = 'none';
                    // Limpiar valores del formulario oculto
                    const inputs = formToShow.querySelectorAll('input:not([type="hidden"]), select, textarea');
                    inputs.forEach(function(input) {
                        if (input.type !== 'hidden') {
                            input.value = '';
                        }
                    });
                    updateFormIndices();
                });
            }
        } else {
            // Si no hay formularios ocultos, crear uno nuevo dinámicamente
            createNewFormDynamically();
        }
        
        updateFormIndices();
    });
    
    // Event listeners para campos que afectan el cálculo
    document.addEventListener('input', function(e) {
        if (e.target.matches('input[name$="cantidad"], input[name$="costo_unitario"], input[name="costo_mano_obra_total"]')) {
            calculateTotals();
        }
    });
    
    // Event listener específico para el checkbox del IVA
    const ivaCheckbox = document.getElementById('id_iva_incluido');
    if (ivaCheckbox) {
        ivaCheckbox.addEventListener('change', calculateTotals);
    }
    
    // Event listeners para botones de eliminar existentes
    document.querySelectorAll('.remove-form').forEach(function(button) {
        button.addEventListener('click', function() {
            const form = button.closest('.formset-form');
            form.style.display = 'none';
            // Limpiar valores
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(function(input) {
                input.value = '';
            });
            updateFormIndices();
        });
    });
    
    // Mostrar el primer formulario inicialmente y ocultar los extra
    const allForms = formsetContainer.querySelectorAll('.formset-form');
    allForms.forEach(function(form, index) {
        if (index === 0) {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    });
    
    // Actualizar el botón "Añadir otro ítem" para mostrar el estado
    function updateAddButton() {
        const visibleForms = formsetContainer.querySelectorAll('.formset-form:not([style*="display: none"])');
        const hiddenForms = formsetContainer.querySelectorAll('.formset-form[style*="display: none"]');
        const maxForms = parseInt(document.getElementById('id_items-MAX_NUM_FORMS').value) || 20;
        
        if (visibleForms.length >= maxForms || hiddenForms.length === 0) {
            addButton.disabled = true;
            addButton.innerHTML = '<i class="bi bi-plus-circle"></i> Límite máximo alcanzado';
        } else {
            addButton.disabled = false;
            addButton.innerHTML = '<i class="bi bi-plus-circle"></i> Añadir otro ítem';
        }
    }
    
    // Inicializar event listeners y cálculos
    attachFormEventListeners();
    updateFormIndices();
    updateAddButton();
});
</script>

<style>
.formset-form {
    transition: all 0.3s ease;
}

.costo-total-display {
    background-color: #f8f9fa !important;
    font-weight: bold;
    color: #198754;
}

#total-materiales, #total-mano-obra, #total-general {
    font-family: monospace;
    font-size: 1.1em;
}
</style>
{% endblock %}