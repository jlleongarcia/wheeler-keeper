{% extends 'maintenance/base.html' %}

{% block title %}Registrar Mantenimiento - Wheeler Keeper{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <form method="post" id="maintenanceForm">
                {% csrf_token %}
                
                <!-- Información Básica del Mantenimiento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> Información Básica</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.vehiculo.id_for_label }}" class="form-label">Vehículo *</label>
                                    {{ form.vehiculo }}
                                    {% if form.vehiculo.errors %}
                                        <div class="text-danger">{{ form.vehiculo.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.fecha_realizacion.id_for_label }}" class="form-label">Fecha de Realización *</label>
                                    {{ form.fecha_realizacion }}
                                    {% if form.fecha_realizacion.errors %}
                                        <div class="text-danger">{{ form.fecha_realizacion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.kilometraje_realizacion.id_for_label }}" class="form-label">Kilometraje *</label>
                                    {{ form.kilometraje_realizacion }}
                                    {% if form.kilometraje_realizacion.errors %}
                                        <div class="text-danger">{{ form.kilometraje_realizacion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.taller.id_for_label }}" class="form-label">Taller/Lugar</label>
                                    {{ form.taller }}
                                    {% if form.taller.errors %}
                                        <div class="text-danger">{{ form.taller.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.costo_mano_obra_total.id_for_label }}" class="form-label">Costo Total de Mano de Obra</label>
                                    <div class="input-group">
                                        {{ form.costo_mano_obra_total }}
                                        <span class="input-group-text">€</span>
                                    </div>
                                    {% if form.costo_mano_obra_total.errors %}
                                        <div class="text-danger">{{ form.costo_mano_obra_total.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.notas_generales.id_for_label }}" class="form-label">Notas Generales</label>
                                    {{ form.notas_generales }}
                                    {% if form.notas_generales.errors %}
                                        <div class="text-danger">{{ form.notas_generales.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Ítems de Mantenimiento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check"></i> Trabajos y Piezas Realizadas</h5>
                        <small class="text-muted">Especifica cada trabajo o pieza individual (mínimo 1 ítem requerido)</small>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        
                        <div id="formset-container">
                            {% for form in formset %}
                                <div class="formset-form border rounded p-3 mb-3" style="{% if forloop.first %}{% else %}display: none;{% endif %}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Ítem <span class="item-number">{{ forloop.counter }}</span></h6>
                                        {% if not forloop.first %}
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-form">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Tipo de Trabajo *</label>
                                                {{ form.tipo_mantenimiento }}
                                                {% if form.tipo_mantenimiento.errors %}
                                                    <div class="text-danger">{{ form.tipo_mantenimiento.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Descripción *</label>
                                                {{ form.descripcion }}
                                                {% if form.descripcion.errors %}
                                                    <div class="text-danger">{{ form.descripcion.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Cantidad</label>
                                                {{ form.cantidad }}
                                                {% if form.cantidad.errors %}
                                                    <div class="text-danger">{{ form.cantidad.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Costo Unitario (€) *</label>
                                                {{ form.costo_unitario }}
                                                {% if form.costo_unitario.errors %}
                                                    <div class="text-danger">{{ form.costo_unitario.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Costo Total</label>
                                                <input type="text" class="form-control costo-total-display" readonly placeholder="0.00 €">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Notas del Ítem</label>
                                                {{ form.notas }}
                                                {% if form.notas.errors %}
                                                    <div class="text-danger">{{ form.notas.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if formset.can_delete %}
                                        {{ form.DELETE }}
                                    {% endif %}
                                    {{ form.id }}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary" id="add-form">
                            <i class="bi bi-plus-circle"></i> Añadir otro ítem
                        </button>
                        
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>Resumen de Costos:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Materiales: <span id="total-materiales">0.00</span> €</strong>
                                </div>
                                <div class="col-md-4">
                                    <strong>Mano de Obra: <span id="total-mano-obra">0.00</span> €</strong>
                                </div>
                                <div class="col-md-4">
                                    <strong>Total: <span id="total-general">0.00</span> €</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-3">
                    <button type="submit" class="btn btn-primary btn-lg me-2">
                        <i class="bi bi-check-circle"></i> Registrar Mantenimiento
                    </button>
                    <a href="{% url 'maintenance:lista_mantenimientos' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Espacio adicional en la parte inferior -->
    <div style="height: 100px;"></div>
</div>

<!-- JavaScript para manejo dinámico de formsets -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    
    // Función para calcular costos totales
    function calculateTotals() {
        let totalMateriales = 0;
        let manoObraTotal = 0;
        
        // Calcular total de materiales (suma de todos los ítems)
        document.querySelectorAll('.formset-form:not([style*="display: none"])').forEach(function(form) {
            const cantidad = parseFloat(form.querySelector('input[name$="cantidad"]').value) || 0;
            const costoUnitario = parseFloat(form.querySelector('input[name$="costo_unitario"]').value) || 0;
            const costoTotal = cantidad * costoUnitario;
            
            // Actualizar display del costo total del ítem
            const costoTotalDisplay = form.querySelector('.costo-total-display');
            if (costoTotalDisplay) {
                costoTotalDisplay.value = costoTotal.toFixed(2) + ' €';
            }
            
            totalMateriales += costoTotal;
        });
        
        // Obtener costo de mano de obra
        const manoObraInput = document.getElementById('id_costo_mano_obra_total');
        if (manoObraInput) {
            manoObraTotal = parseFloat(manoObraInput.value) || 0;
        }
        
        // Actualizar displays
        document.getElementById('total-materiales').textContent = totalMateriales.toFixed(2);
        document.getElementById('total-mano-obra').textContent = manoObraTotal.toFixed(2);
        document.getElementById('total-general').textContent = (totalMateriales + manoObraTotal).toFixed(2);
    }
    
    // Función para actualizar índices de formularios
    function updateFormIndices() {
        const forms = formsetContainer.querySelectorAll('.formset-form:not([style*="display: none"])');
        forms.forEach(function(form, index) {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(function(input) {
                if (input.name) {
                    input.name = input.name.replace(/items-\d+-/, `items-${index}-`);
                }
                if (input.id) {
                    input.id = input.id.replace(/id_items-\d+-/, `id_items-${index}-`);
                }
            });
            
            const labels = form.querySelectorAll('label[for]');
            labels.forEach(function(label) {
                if (label.htmlFor) {
                    label.htmlFor = label.htmlFor.replace(/id_items-\d+-/, `id_items-${index}-`);
                }
            });
            
            // Actualizar número del ítem
            const itemNumber = form.querySelector('.item-number');
            if (itemNumber) {
                itemNumber.textContent = index + 1;
            }
        });
        
        totalFormsInput.value = forms.length;
        calculateTotals();
    }
    
    // Función para añadir nuevo formulario
    addButton.addEventListener('click', function() {
        const hiddenForms = formsetContainer.querySelectorAll('.formset-form[style*="display: none"]');
        
        if (hiddenForms.length > 0) {
            // Mostrar el primer formulario oculto
            const formToShow = hiddenForms[0];
            formToShow.style.display = 'block';
            
            // Añadir botón de eliminar si no lo tiene
            const removeButton = formToShow.querySelector('.remove-form');
            if (removeButton) {
                removeButton.addEventListener('click', function() {
                    formToShow.style.display = 'none';
                    // Limpiar valores del formulario oculto
                    const inputs = formToShow.querySelectorAll('input:not([type="hidden"]), select, textarea');
                    inputs.forEach(function(input) {
                        input.value = '';
                    });
                    updateFormIndices();
                });
            }
        }
        
        updateFormIndices();
    });
    
    // Event listeners para campos que afectan el cálculo
    document.addEventListener('input', function(e) {
        if (e.target.matches('input[name$="cantidad"], input[name$="costo_unitario"], input[name="costo_mano_obra_total"]')) {
            calculateTotals();
        }
    });
    
    // Event listeners para botones de eliminar existentes
    document.querySelectorAll('.remove-form').forEach(function(button) {
        button.addEventListener('click', function() {
            const form = button.closest('.formset-form');
            form.style.display = 'none';
            // Limpiar valores
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(function(input) {
                input.value = '';
            });
            updateFormIndices();
        });
    });
    
    // Mostrar solo el primer formulario inicialmente
    const allForms = formsetContainer.querySelectorAll('.formset-form');
    allForms.forEach(function(form, index) {
        if (index === 0) {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    });
    
    // Inicializar cálculos
    updateFormIndices();
});
</script>

<style>
.formset-form {
    transition: all 0.3s ease;
}

.costo-total-display {
    background-color: #f8f9fa !important;
    font-weight: bold;
    color: #198754;
}

#total-materiales, #total-mano-obra, #total-general {
    font-family: monospace;
    font-size: 1.1em;
}
</style>
{% endblock %}